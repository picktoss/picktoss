import { PropsWithChildren, createContext, useContext, useEffect, useMemo } from 'react'

import { init, track } from '@amplitude/analytics-browser'

/**
 * Amplitude API Key
 */
const AMPLITUDE_API_KEY = import.meta.env.VITE_AMPLITUDE_API_KEY || ''

/* -------------------------------------------------------------------------- */
/*                           [이벤트별 Props 정의]                             */
/* -------------------------------------------------------------------------- */

// 데일리 이벤트
/** [데일리] daily_star_click - 헤더 별 아이콘 클릭 */
export interface DailyStarClickProps {}

/** [데일리] daily_complete_click - 10문제 완료 리워드 drawer에서 '확인' 버튼 클릭 */
export interface DailyCompleteClickProps {}

/** [데일리] daily_setting_type_click - 퀴즈 설정 drawer 문제 유형 영역 내 옵션 클릭 */
export interface DailySettingTypeClickProps {
  type: '전체' | '객관식' | 'O/X'
}

/** [데일리] daily_setting_range_click - 퀴즈 설정 drawer 문제 범위 영역 내 옵션 클릭 */
export interface DailySettingRangeClickProps {
  range: '전체' | '내 퀴즈' | '북마크'
}

/** [데일리] daily_setting_save_click - 퀴즈 설정 drawer에서 '저장'버튼 클릭 */
export interface DailySettingSaveClickProps {}

/** [데일리] daily_quiz_add_click - 퀴즈 만들기 버튼 클릭 */
export interface DailyQuizAddClickProps {
  format: '텍스트 버튼' | '파일 버튼'
}

// 도서관 이벤트
/** [도서관] library_myquiz_click - 내 퀴즈 목록에 있는 아이템 클릭 */
export interface LibraryMyquizClickProps {}

/** [도서관] library_bookmark_click - 북마크 목록에 있는 아이템 클릭 */
export interface LibraryBookmarkClickProps {}

/** [도서관] library_quiz_add_click - 노트 추가 버튼 클릭 */
export interface LibraryQuizAddClickProps {}

/** [도서관] library_quiz_edit_click - 노트 상세-퀴즈 수정 버튼 클릭 */
export interface LibraryQuizEditClickProps {}

/** [도서관] library_toolbar_share_click - 노트 상세 공유하기 버튼 클릭 */
export interface LibraryToolbarShareClickProps {}

/** [도서관] library_toolbar_play_click - 노트 상세 툴바- 플레이 버튼 클릭 */
export interface LibraryToolbarPlayClickProps {}

/** [도서관] library_toolbar_review_click - 노트 상세 툴바- 복습 pick 버튼 클릭 */
export interface LibraryToolbarReviewClickProps {}

/** [도서관] library_toolbar_note_click - 노트 상세 툴바- 원본 노트 버튼 클릭 */
export interface LibraryToolbarNoteClickProps {}

/** [도서관] library_toolbar_more_click - 노트 상세 툴바- 더보기 버튼 클릭 */
export interface LibraryToolbarMoreClickProps {}

/** [도서관] library_toolbar_answer_click - 노트 상세 툴바- 정답 표시 스위치 클릭 */
export interface LibraryToolbarAnswerClickProps {
  value: boolean
}

// 탐험 이벤트
/** [탐험] explore_quizstart_click - 탐험에서 '퀴즈 시작하기'버튼 클릭 */
export interface ExploreQuizstartClickProps {
  location: '미리보기 페이지' | '상세 페이지'
}

/** [탐험] explore_tab_click - 분야 tab 클릭 */
export interface ExploreTabClickProps {
  category: '전체' | '자격증·수험' | '학문·전공' | 'IT·개발' | '재테크·시사' | '언어' | '상식·교양'
}

/** [탐험] explore_bookmark_click - 북마크 버튼 클릭 */
export interface ExploreBookmarkClickProps {
  location: '미리보기 페이지' | '상세 페이지'
}

/** [탐험] explore_share_click - 공유 버튼 클릭 */
export interface ExploreShareClickProps {
  location: '미리보기 페이지' | '상세 페이지'
}

/** [탐험] explore_detail_click - 퀴즈 질문 미리보기에서 '전체보기'버튼 클릭 */
export interface ExploreDetailClickProps {
  type: '만든 컬렉션' | '보관한 컬렉션' | '탐색'
}

// 퀴즈 생성 이벤트
/** [퀴즈 생성] generate_tab_click - 상단 tab 클릭 */
export interface GenerateTabClickProps {
  tab: '텍스트' | '파일'
}

/** [퀴즈 생성] generate_quiz_click - 퀴즈 생성하기' 버튼 클릭 */
export interface GenerateQuizClickProps {}

/** [퀴즈 생성] generate_quiz_start_click - 퀴즈 로딩 완료 후 '퀴즈 시작' 버튼 클릭 */
export interface GenerateQuizStartClickProps {}

/** [퀴즈 생성] generate_quiz_later_click - 퀴즈 로딩 완료 후 '다음에' 버튼 클릭 */
export interface GenerateQuizLaterClickProps {}

// 퀴즈 이벤트
/** [퀴즈] quiz_complete_view - 퀴즈 결과 페이지 조회 */
export interface QuizCompleteViewProps {}

/** [퀴즈] quiz_setting_time_click - 퀴즈 설정 drawer 시간 숨기기 switch 클릭 */
export interface QuizSettingTimeClickProps {
  value: boolean
}

/** [퀴즈] quiz_setting_skip_click - 퀴즈 설정 drawer 문제 바로 넘기기 switch 클릭 */
export interface QuizSettingSkipClickProps {
  value: boolean
}

/** [퀴즈] quiz_setting_save_click - 퀴즈 설정 drawer에서 '저장'버튼 클릭 */
export interface QuizSettingSaveClickProps {}

/** [퀴즈] quiz_exit_click - 퀴즈 나가기' 버튼 클릭 */
export interface QuizExitClickProps {}

// 마이 이벤트
/** [마이] my_analysis_click - 퀴즈 분석 메뉴 클릭 */
export interface MyAnalysisClickProps {}

/** [마이] my_star_click - 나의 별 메뉴 클릭 */
export interface MyStarClickProps {}

/** [마이] my_history_click - 퀴즈 기록 메뉴 클릭 */
export interface MyHistoryClickProps {}

// 친구 초대 이벤트
/** [친구 초대] invite_view - 친구 초대하기 시트 조회 */
export interface InviteViewProps {}

/** [친구 초대] invite_share_click - 친구 초대하기 시트에서 버튼 클릭 */
export interface InviteShareClickProps {
  method: '복사' | '카카오톡' | '일반 공유'
}

// 계정 이벤트 (기존 코드에서 유지)
/** [온보딩] account_create */
export interface AccountCreateProps {
  type: '구글' | '카카오'
}

/** [퀴즈노트] quiz_replay */
export interface QuizReplayProps {
  type: '전체' | '객관식' | 'OX'
}

/* -------------------------------------------------------------------------- */
/*                            Amplitude 컨텍스트                              */
/* -------------------------------------------------------------------------- */

/**
 * 이벤트 타입 정의
 */
export type EventName =
  // 데일리
  | 'daily_star_click'
  | 'daily_complete_click'
  | 'daily_setting_type_click'
  | 'daily_setting_range_click'
  | 'daily_setting_save_click'
  | 'daily_quiz_add_click'
  // 도서관
  | 'library_myquiz_click'
  | 'library_bookmark_click'
  | 'library_quiz_add_click'
  | 'library_quiz_edit_click'
  | 'library_toolbar_share_click'
  | 'library_toolbar_play_click'
  | 'library_toolbar_review_click'
  | 'library_toolbar_note_click'
  | 'library_toolbar_more_click'
  | 'library_toolbar_answer_click'
  // 탐험
  | 'explore_quizstart_click'
  | 'explore_tab_click'
  | 'explore_bookmark_click'
  | 'explore_share_click'
  | 'explore_detail_click'
  // 퀴즈 생성
  | 'generate_tab_click'
  | 'generate_quiz_click'
  | 'generate_quiz_start_click'
  | 'generate_quiz_later_click'
  // 퀴즈
  | 'quiz_complete_view'
  | 'quiz_setting_time_click'
  | 'quiz_setting_skip_click'
  | 'quiz_setting_save_click'
  | 'quiz_exit_click'
  // 마이
  | 'my_analysis_click'
  | 'my_star_click'
  | 'my_history_click'
  // 친구 초대
  | 'invite_view'
  | 'invite_share_click'
  // 계정
  | 'account_create'
  // 기타
  | 'quiz_replay'

/**
 * 이벤트별 프로퍼티 타입 매핑
 */
export type EventPropsMap = {
  // 데일리
  daily_star_click: DailyStarClickProps
  daily_complete_click: DailyCompleteClickProps
  daily_setting_type_click: DailySettingTypeClickProps
  daily_setting_range_click: DailySettingRangeClickProps
  daily_setting_save_click: DailySettingSaveClickProps
  daily_quiz_add_click: DailyQuizAddClickProps
  // 도서관
  library_myquiz_click: LibraryMyquizClickProps
  library_bookmark_click: LibraryBookmarkClickProps
  library_quiz_add_click: LibraryQuizAddClickProps
  library_quiz_edit_click: LibraryQuizEditClickProps
  library_toolbar_share_click: LibraryToolbarShareClickProps
  library_toolbar_play_click: LibraryToolbarPlayClickProps
  library_toolbar_review_click: LibraryToolbarReviewClickProps
  library_toolbar_note_click: LibraryToolbarNoteClickProps
  library_toolbar_more_click: LibraryToolbarMoreClickProps
  library_toolbar_answer_click: LibraryToolbarAnswerClickProps
  // 탐험
  explore_quizstart_click: ExploreQuizstartClickProps
  explore_tab_click: ExploreTabClickProps
  explore_bookmark_click: ExploreBookmarkClickProps
  explore_share_click: ExploreShareClickProps
  explore_detail_click: ExploreDetailClickProps
  // 퀴즈 생성
  generate_tab_click: GenerateTabClickProps
  generate_quiz_click: GenerateQuizClickProps
  generate_quiz_start_click: GenerateQuizStartClickProps
  generate_quiz_later_click: GenerateQuizLaterClickProps
  // 퀴즈
  quiz_complete_view: QuizCompleteViewProps
  quiz_setting_time_click: QuizSettingTimeClickProps
  quiz_setting_skip_click: QuizSettingSkipClickProps
  quiz_setting_save_click: QuizSettingSaveClickProps
  quiz_exit_click: QuizExitClickProps
  // 마이
  my_analysis_click: MyAnalysisClickProps
  my_star_click: MyStarClickProps
  my_history_click: MyHistoryClickProps
  // 친구 초대
  invite_view: InviteViewProps
  invite_share_click: InviteShareClickProps
  // 계정
  account_create: AccountCreateProps
  // 기타
  quiz_replay: QuizReplayProps
}

/**
 * Amplitude 컨텍스트 타입
 */
type AmplitudeContextType = {
  /**
   * 이벤트 추적 함수
   * @param eventName 이벤트 이름
   * @param eventProperties 이벤트 프로퍼티
   */
  trackEvent: <T extends EventName>(eventName: T, eventProperties?: EventPropsMap[T]) => void
}

/**
 * Amplitude 컨텍스트 생성
 */
const AmplitudeContext = createContext<AmplitudeContextType | null>(null)

/**
 * Amplitude 프로바이더 컴포넌트
 */
export const AmplitudeProvider = ({ children }: PropsWithChildren) => {
  // Amplitude 초기화
  useEffect(() => {
    if (!AMPLITUDE_API_KEY) {
      console.warn('Amplitude API Key가 없습니다.')
      return
    }

    init(AMPLITUDE_API_KEY, undefined, {
      logLevel: import.meta.env.DEV ? 'Debug' : 'Error',
    })
  }, [])

  // 컨텍스트 값 생성
  const contextValue = useMemo<AmplitudeContextType>(
    () => ({
      trackEvent: (eventName, eventProperties) => {
        if (!AMPLITUDE_API_KEY) {
          console.warn(`Amplitude API Key가 없어 이벤트 ${eventName}를 추적할 수 없습니다.`)
          return
        }

        track(eventName, eventProperties)
        
        if (import.meta.env.DEV) {
          console.log(`[픽토스 이벤트] ${eventName}`, eventProperties)
        }
      },
    }),
    [],
  )

  return <AmplitudeContext.Provider value={contextValue}>{children}</AmplitudeContext.Provider>
}

/**
 * Amplitude 컨텍스트 훈
 */
export const useAmplitude = () => {
  const context = useContext(AmplitudeContext)
  if (!context) {
    throw new Error('useAmplitude는 AmplitudeProvider 내부에서만 사용할 수 있습니다.')
  }
  return context
}

/** [퀴즈노트] answer_view_change */
export interface AnswerViewChangeProps {
  /** True, False (정답 보기 토글 여부) */
  status: boolean
}

/** [컬렉션] collection_add_click */
export interface CollectionAddClickProps {
  option: '헤더' | '내 컬렉션'
}

/** [컬렉션] collection_create */
export interface CollectionCreateClickProps {
  /** 'IT·프로그래밍', '경영·경제' 등 */
  category: (typeof CATEGORIES)[number]['name']
}

/** [컬렉션] collection_item_click */
export interface CollectionItemClickProps {
  type: '만든 컬렉션' | '보관한 컬렉션' | '탐색'
}

/** [컬렉션] filter_category_apply */
export interface FilterCategoryApplyProps {
  /** 'IT·프로그래밍', '경영·경제', '과학·공학' 등 */
  category: (typeof CATEGORIES)[number]['name']
}

/** [컬렉션] filter_quiztype_apply */
export interface FilterQuiztypeApplyProps {
  type: '객관식' | 'OX'
}

/** [컬렉션] collection_sort_change */
export interface CollectionSortChangeProps {
  option: '인기' | '최신'
}

/** [퀴즈] quiz_start, quiz_complete, quiz_exit */
export interface QuizStartClickProps {
  type: '오늘의 퀴즈' | '퀴즈노트' | '컬렉션'
  /** 1~24 (오늘의 퀴즈 시작 시간대) */
  time?: number
}

/** [마이] quickmenu_click */
export interface QuickmenuClickProps {
  option: '내 컬렉션' | '퀴즈 분석' | '퀴즈 기록'
}

/** [PRO 구독] purchase_click, purchase_complete */
export interface PurchaseClickProps {
  /** 결제 금액 */
  price: number
}
export interface PurchaseCompleteProps {
  /** 결제 금액 */
  price: number
}

/** [친구 초대] share_click */
export interface ShareClickProps {
  method: '복사' | '카카오톡' | '일반 공유'
}

/* -------------------------------------------------------------------------- */
/*                   [AmplitudeContext에서 제공할 메서드 목록]                 */
/* -------------------------------------------------------------------------- */

export interface Values {
  /**
   * (공통) 임의 이벤트 트래킹용 메서드
   */
  trackAmplitudeEvent: <T extends Record<string, unknown>>(eventName: string, eventProperties?: T) => void

  /* -------------------------- [온보딩] -------------------------- */
  // accountCreateEvent: (props: AccountCreateProps) => void
  onboardStartEvent: () => void
  onboardInterestSaveEvent: () => void

  /* -------------------------- [홈] -------------------------- */
  analysisClickEvent: () => void
  historyClickEvent: () => void
  bombquizClickEvent: () => void
  bombquizCloseEvent: () => void
  randomquizClickEvent: () => void
  randomquizChangeClickEvent: (props: RandomquizChangeClickProps) => void
  randomquizCloseClickEvent: () => void
  top5NoteClickEvent: (props: Top5NoteClickProps) => void
  interestItemClickEvent: () => void
  interestItemMoreClickEvent: () => void

  /* -------------------------- [퀴즈노트] -------------------------- */
  noteClickEvent: () => void
  noteAddClickEvent: (props: NoteAddClickProps) => void
  noteViewEvent: () => void
  noteCloseEvent: () => void
  noteEditEvent: () => void
  quizCreateEvent: (props: QuizCreateProps) => void
  quizReplayEvent: (props: QuizReplayProps) => void
  reviewClickEvent: () => void
  quizTabClickEvent: () => void
  noteTabClickEvent: () => void
  answerViewChangeEvent: (props: AnswerViewChangeProps) => void
  addToCollectionClickEvent: () => void

  /* -------------------------- [컬렉션] -------------------------- */
  collectionAddClickEvent: (props: CollectionAddClickProps) => void
  collectionCreateClickEvent: (props: CollectionCreateClickProps) => void
  collectionItemClickEvent: (props: CollectionItemClickProps) => void
  // filterCategoryApplyEvent: (props: FilterCategoryApplyProps) => void
  // filterQuiztypeApplyEvent: (props: FilterQuiztypeApplyProps) => void
  collectionSortChangeEvent: (props: CollectionSortChangeProps) => void

  /* -------------------------- [퀴즈] -------------------------- */
  quizStartClickEvent: (props: QuizStartClickProps) => void
  quizCompleteViewEvent: () => void
  quizExitClickEvent: () => void

  /* -------------------------- [마이] -------------------------- */
  quickmenuClickEvent: (props: QuickmenuClickProps) => void
  interestSaveEvent: () => void

  /* -------------------------- [PRO 구독] -------------------------- */
  proPurchaseViewEvent: () => void
  purchaseClickEvent: (props: PurchaseClickProps) => void
  purchaseCompleteEvent: (props: PurchaseCompleteProps) => void

  /* -------------------------- [친구 초대] -------------------------- */
  inviteViewEvent: () => void
  shareClickEvent: (props: ShareClickProps) => void
}

/* -------------------------------------------------------------------------- */
/*                        [Context & Provider 구현]                           */
/* -------------------------------------------------------------------------- */

export const AmplitudeContext = createContext<Values | null>(null)

export const AmplitudeContextProvider = ({ children }: PropsWithChildren) => {
  const pathname = usePathname()

  useEffect(() => {
    // production 환경에서만 Amplitude 초기화
    if (process.env.NODE_ENV === 'production') {
      init(AMPLITUDE_API_KEY, undefined, {
        defaultTracking: {
          sessions: true,
        },
      })
    }
  }, [])

  /**
   * 공통 트래킹 함수
   */
  const trackAmplitudeEvent = <T extends Record<string, unknown>>(eventName: string, eventProperties?: T) => {
    track(eventName, eventProperties)
  }

  /**
   * 주어진 이벤트 표에 따라 메서드 구현
   */
  const value = useMemo<Values>(
    () => ({
      trackAmplitudeEvent,

      /* ---------------------- [온보딩] ---------------------- */
      // accountCreateEvent: (props) => trackAmplitudeEvent('account_create', { ...props, pathname }),
      onboardStartEvent: () => trackAmplitudeEvent('onboard_start', { pathname }),
      onboardInterestSaveEvent: () => trackAmplitudeEvent('onboard_interest_save', { pathname }),

      /* ---------------------- [홈] ---------------------- */
      analysisClickEvent: () => trackAmplitudeEvent('analysis_click', { pathname }),
      historyClickEvent: () => trackAmplitudeEvent('history_click', { pathname }),
      bombquizClickEvent: () => trackAmplitudeEvent('bombquiz_start', { pathname }),
      bombquizCloseEvent: () => trackAmplitudeEvent('bombquiz_exit', { pathname }),
      randomquizClickEvent: () => trackAmplitudeEvent('randomquiz_start', { pathname }),
      randomquizChangeClickEvent: (props) => trackAmplitudeEvent('randomquiz_change', { ...props, pathname }),
      randomquizCloseClickEvent: () => trackAmplitudeEvent('randomquiz_exit', { pathname }),
      top5NoteClickEvent: (props) => trackAmplitudeEvent('top5_note_click', { ...props, pathname }),
      interestItemClickEvent: () => trackAmplitudeEvent('interest_item_click', { pathname }),
      interestItemMoreClickEvent: () => trackAmplitudeEvent('interest_item_more_click', { pathname }),

      /* ---------------------- [퀴즈노트] ---------------------- */
      noteClickEvent: () => trackAmplitudeEvent('note_click', { pathname }),
      noteAddClickEvent: (props) => trackAmplitudeEvent('note_add_click', { ...props, pathname }),
      noteViewEvent: () => trackAmplitudeEvent('note_view', { pathname }),
      noteCloseEvent: () => trackAmplitudeEvent('note_close', { pathname }),
      noteEditEvent: () => trackAmplitudeEvent('note_edit', { pathname }),
      quizCreateEvent: (props) => trackAmplitudeEvent('quiz_create', { ...props, pathname }),
      quizReplayEvent: (props) => trackAmplitudeEvent('quiz_replay', { ...props, pathname }),
      reviewClickEvent: () => trackAmplitudeEvent('review_click', { pathname }),
      quizTabClickEvent: () => trackAmplitudeEvent('quiz_tab_click', { pathname }),
      noteTabClickEvent: () => trackAmplitudeEvent('note_tab_click', { pathname }),
      answerViewChangeEvent: (props) => trackAmplitudeEvent('answer_view_change', { ...props, pathname }),
      addToCollectionClickEvent: () => trackAmplitudeEvent('add_to_collection_click', { pathname }),

      /* ---------------------- [컬렉션] ---------------------- */
      collectionAddClickEvent: (props) => trackAmplitudeEvent('collection_add_click', { ...props, pathname }),
      collectionCreateClickEvent: (props) => trackAmplitudeEvent('collection_create', { ...props, pathname }),
      collectionItemClickEvent: (props) => trackAmplitudeEvent('collection_item_click', { ...props, pathname }),
      // filterCategoryApplyEvent: (props) =>
      //   trackAmplitudeEvent('filter_category_apply', { ...props, pathname }),
      // filterQuiztypeApplyEvent: (props) =>
      //   trackAmplitudeEvent('filter_quiztype_apply', { ...props, pathname }),
      collectionSortChangeEvent: (props) => trackAmplitudeEvent('collection_sort_change', { ...props, pathname }),

      /* ---------------------- [퀴즈] ---------------------- */
      quizStartClickEvent: (props) => trackAmplitudeEvent('quiz_start', { ...props, pathname }),
      quizCompleteViewEvent: () => trackAmplitudeEvent('quiz_complete', { pathname }),
      quizExitClickEvent: () => trackAmplitudeEvent('quiz_exit', { pathname }),

      /* ---------------------- [마이] ---------------------- */
      quickmenuClickEvent: (props) => trackAmplitudeEvent('quickmenu_click', { ...props, pathname }),
      interestSaveEvent: () => trackAmplitudeEvent('interest_save', { pathname }),

      /* ---------------------- [PRO 구독] ---------------------- */
      proPurchaseViewEvent: () => trackAmplitudeEvent('pro_purchase_view', { pathname }),
      purchaseClickEvent: (props) => trackAmplitudeEvent('purchase_click', { ...props, pathname }),
      purchaseCompleteEvent: (props) => trackAmplitudeEvent('purchase_complete', { ...props, pathname }),

      /* ---------------------- [친구 초대] ---------------------- */
      inviteViewEvent: () => trackAmplitudeEvent('invite_view', { pathname }),
      shareClickEvent: (props) => trackAmplitudeEvent('share_click', { ...props, pathname }),
    }),
    [pathname],
  )

  return <AmplitudeContext.Provider value={value}>{children}</AmplitudeContext.Provider>
}

/**
 * AmplitudeContext 사용을 위한 커스텀 훅
 */
export const useAmplitudeContext = () => {
  const context = useContext(AmplitudeContext)
  if (context == null) {
    throw new Error('useAmplitudeContext must be used within an AmplitudeContextProvider')
  }
  return context
}
